<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Preæ ‡ç­¾æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
        // åˆå§‹åŒ–Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    <style>
        .markdown-content {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }
        .markdown-content h1 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .markdown-content h2 {
            color: #444;
            margin-top: 20px;
        }
        .markdown-content p {
            margin-bottom: 15px;
            color: #555;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        .markdown-content li {
            margin-bottom: 8px;
        }
        .markdown-content code {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .markdown-content pre {
            background: #e8e8e8;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        .markdown-content blockquote {
            border-left: 4px solid #667eea;
            padding: 10px 20px;
            margin: 15px 0;
            background: #f0f0f0;
            color: #666;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div style="text-align: center; padding: 20px;">
        <h1> Markdown Preæ ‡ç­¾æ¸²æŸ“æµ‹è¯• </h1>
        <button onclick="testPreRendering()">æµ‹è¯•Preæ ‡ç­¾æ¸²æŸ“</button>
        <button onclick="testNestedContent()">æµ‹è¯•åµŒå¥—å†…å®¹</button>
        <button onclick="testMermaidRendering()">æµ‹è¯•Mermaidå›¾è¡¨</button>
        <button onclick="testMixedContent()">æµ‹è¯•æ··åˆå†…å®¹</button>
        <button onclick="clearContent()">æ¸…ç©ºå†…å®¹</button>
    </div>
    
    <div id="content" style="margin: 20px;"></div>

    <script>
        // æ¸²æŸ“markdown-contentä¸‹çš„preæ ‡ç­¾å†…å®¹ä¸ºMarkdownè¾“å‡º
        function renderPreTagMarkdown(parentElement = document) {
            try {
                // æŸ¥æ‰¾æ‰€æœ‰markdown-contentå…ƒç´ ä¸‹çš„preæ ‡ç­¾
                const markdownContents = parentElement.querySelectorAll('.markdown-content');
                markdownContents.forEach(markdownContent => {
                    const preTags = markdownContent.querySelectorAll('pre');
                    preTags.forEach(preTag => {
                        try {
                            // è·å–preæ ‡ç­¾å†…çš„æ–‡æœ¬å†…å®¹
                            const contentText = preTag.textContent || preTag.innerText;
                            if (contentText && contentText.trim()) {
                                const trimmedContent = contentText.trim();
                                
                                // æ£€æŸ¥æ˜¯å¦ä¸ºMermaidä»£ç 
                                if (isMermaidCode(trimmedContent)) {
                                    // æ¸²æŸ“ä¸ºMermaidå›¾è¡¨
                                    renderMermaidFromPreTag(trimmedContent, preTag);
                                } else {
                                    // ä½¿ç”¨markedè§£æMarkdownå†…å®¹
                                    if (typeof marked !== 'undefined' && marked.parse) {
                                        const renderedHtml = marked.parse(trimmedContent);
                                        // åˆ›å»ºæ–°çš„divå…ƒç´ åŒ…å«æ¸²æŸ“åçš„å†…å®¹
                                        const newDiv = document.createElement('div');
                                        newDiv.className = 'markdown-content';
                                        newDiv.innerHTML = renderedHtml;
                                        // ç”¨æ–°å…ƒç´ æ›¿æ¢åŸæ¥çš„preæ ‡ç­¾
                                        preTag.parentNode.replaceChild(newDiv, preTag);
                                    } else {
                                        console.warn('âš ï¸ Marked.jsæœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“preæ ‡ç­¾å†…å®¹ä¸ºMarkdown');
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('âš ï¸ æ¸²æŸ“preæ ‡ç­¾å†…å®¹æ—¶å‡ºé”™:', error);
                        }
                    });
                });
            } catch (error) {
                console.warn('âš ï¸ æ¸²æŸ“preæ ‡ç­¾Markdownæ—¶å‡ºé”™:', error);
            }
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºMermaidä»£ç 
        function isMermaidCode(code) {
            if (!code || code.length === 0) return false;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„èµ·å§‹è¡Œ
            const firstLine = code.split('\n')[0].trim();
            const validStarts = ['graph', 'flowchart', 'sequenceDiagram', 'classDiagram', 
                               'stateDiagram', 'erDiagram', 'gantt', 'pie', 'journey',
                               'requirementDiagram', 'gitGraph'];
            
            return validStarts.some(start => firstLine.startsWith(start));
        }

        // ä»preæ ‡ç­¾æ¸²æŸ“Mermaidå›¾è¡¨
        function renderMermaidFromPreTag(mermaidCode, originalPreTag) {
            try {
                // åˆ›å»ºMermaidå›¾è¡¨å®¹å™¨
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                mermaidDiv.style.backgroundColor = '#ffffff';
                mermaidDiv.style.borderRadius = '8px';
                mermaidDiv.style.padding = '20px';
                mermaidDiv.style.margin = '20px 0';
                mermaidDiv.style.boxShadow = '0 2px 8px rgba(0, 0.1)';
                mermaidDiv.style.overflow = 'auto';
                mermaidDiv.setAttribute('data-mermaid-code', mermaidCode); // ä¿å­˜åŸå§‹ä»£ç ç”¨äºé‡è¯•
                
                // ç”¨Mermaidå›¾è¡¨æ›¿æ¢åŸæ¥çš„preæ ‡ç­¾
                originalPreTag.parentNode.replaceChild(mermaidDiv, originalPreTag);
                
                // æ¸²æŸ“Mermaidå›¾è¡¨
                renderMermaidWithRetry(mermaidDiv);
            } catch (error) {
                console.warn('âš ï¸ æ¸²æŸ“preæ ‡ç­¾ä¸­çš„Mermaidå›¾è¡¨æ—¶å‡ºé”™:', error);
            }
        }

        // å¸¦é‡è¯•æœºåˆ¶çš„Mermaidæ¸²æŸ“
        function renderMermaidWithRetry(mermaidElement, retryCount = 0) {
            const maxRetries = 5;
            const retryDelay = 500; // 500msé‡è¯•é—´éš”
            
            // æ£€æŸ¥Mermaidæ˜¯å¦å·²åŠ è½½å¹¶åˆå§‹åŒ–
            if (typeof mermaid === 'undefined') {
                if (retryCount < maxRetries) {
                    console.log(`â³ MermaidæœªåŠ è½½ï¼Œ${retryDelay}msåé‡è¯• (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => renderMermaidWithRetry(mermaidElement, retryCount + 1), retryDelay);
                } else {
                    console.warn('âš ï¸ Mermaidåº“åŠ è½½è¶…æ—¶ï¼Œæ— æ³•æ¸²æŸ“å›¾è¡¨');
                    showMermaidFallback(mermaidElement);
                }
                return;
            }
            
            // ä½¿ç”¨ç°ä»£çš„Mermaid APIæ¸²æŸ“
            try {
                mermaid.run({
                    nodes: [mermaidElement],
                    postRenderCallback: (id) => {
                        console.log('âœ… Preæ ‡ç­¾ä¸­çš„Mermaidå›¾è¡¨æ¸²æŸ“å®Œæˆ:', id);
                    }
                }).catch((error) => {
                    if (retryCount < maxRetries) {
                        console.log(`â³ Mermaidæ¸²æŸ“å¤±è´¥ï¼Œ${retryDelay}msåé‡è¯• (${retryCount + 1}/${maxRetries}):`, error.message);
                        setTimeout(() => renderMermaidWithRetry(mermaidElement, retryCount + 1), retryDelay);
                    } else {
                        console.warn('âš ï¸ Mermaidæ¸²æŸ“é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™:', error);
                        showMermaidFallback(mermaidElement);
                    }
                });
            } catch (e) {
                if (retryCount < maxRetries) {
                    console.log(`â³ Mermaidæ¸²æŸ“å¼‚å¸¸ï¼Œ${retryDelay}msåé‡è¯• (${retryCount + 1}/${maxRetries}):`, e.message);
                    setTimeout(() => renderMermaidWithRetry(mermaidElement, retryCount + 1), retryDelay);
                } else {
                    console.warn('âš ï¸ Mermaidæ¸²æŸ“å¼‚å¸¸é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™:', e);
                    showMermaidFallback(mermaidElement);
                }
            }
        }

        // Mermaidæ¸²æŸ“å¤±è´¥æ—¶çš„é™çº§æ˜¾ç¤º
        function showMermaidFallback(mermaidElement) {
            const code = mermaidElement.getAttribute('data-mermaid-code') || mermaidElement.textContent;
            mermaidElement.innerHTML = `
                <div style="text-align: left; font-family: monospace; font-size: 12px; color: #666;">
                    <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #ffc107;">
                        <strong>âš ï¸ Mermaidå›¾è¡¨æ¸²æŸ“å¤±è´¥</strong><br>
                        ä»¥ä¸‹æ˜¯åŸå§‹Mermaidä»£ç ï¼š
                    </div>
                    <pre style="background: #f1f3f4; padding: 15px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(code)}</pre>
                    <div style="margin-top: 10px; font-size: 11px; color: #888;">
                        æç¤ºï¼šè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•
                    </div>
                </div>
            `;
        }

        // HTMLè½¬ä¹‰è¾…åŠ©å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&',
                '<': '<',
                '>': '>',
                '"': '"',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // å¯åŠ¨MermaidæŒç»­æ£€æµ‹æœºåˆ¶
        function startMermaidDetection() {
            let detectionCount = 0;
            const maxDetections = 50; // æœ€å¤šæ£€æµ‹50æ¬¡ï¼ˆ5ç§’ï¼‰
            const detectionInterval = 100; // 100æ¯«ç§’æ£€æµ‹ä¸€æ¬¡
            
            const detectionTimer = setInterval(() => {
                detectionCount++;
                
                // æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦æœ‰æœªæ¸²æŸ“çš„Mermaidä»£ç å—
                const unrenderedMermaidBlocks = findUnrenderedMermaidBlocks();
                
                if (unrenderedMermaidBlocks.length > 0) {
                    console.log(`ğŸ” æ£€æµ‹åˆ° ${unrenderedMermaidBlocks.length} ä¸ªæœªæ¸²æŸ“çš„Mermaidä»£ç å—ï¼Œæ­£åœ¨è¿›è¡Œæ¸²æŸ“...`);
                    
                    // æ¸²æŸ“æœªæ¸²æŸ“çš„Mermaidä»£ç å—
                    unrenderedMermaidBlocks.forEach(block => {
                        const codeContent = block.textContent.trim();
                        if (codeContent && isMermaidCode(codeContent)) {
                            // åˆ›å»ºMermaidå›¾è¡¨å®¹å™¨
                            const mermaidDiv = document.createElement('div');
                            mermaidDiv.className = 'mermaid';
                            mermaidDiv.textContent = codeContent;
                            mermaidDiv.style.backgroundColor = '#ffffff';
                            mermaidDiv.style.borderRadius = '8px';
                            mermaidDiv.style.padding = '20px';
                            mermaidDiv.style.margin = '20px 0';
                            mermaidDiv.style.boxShadow = '0 2px 8px rgba(0, 0.1)';
                            mermaidDiv.style.overflow = 'auto';
                            mermaidDiv.setAttribute('data-mermaid-code', codeContent);
                            
                            // æ›¿æ¢åŸæ¥çš„ä»£ç å—
                            block.parentNode.replaceChild(mermaidDiv, block);
                            
                            // æ¸²æŸ“Mermaidå›¾è¡¨
                            renderMermaidWithRetry(mermaidDiv);
                        }
                    });
                }
                
                // è¾¾åˆ°æœ€å¤§æ£€æµ‹æ¬¡æ•°æˆ–æ²¡æœ‰æœªæ¸²æŸ“çš„å—æ—¶åœæ­¢æ£€æµ‹
                if (detectionCount >= maxDetections || unrenderedMermaidBlocks.length === 0) {
                    clearInterval(detectionTimer);
                    if (detectionCount < maxDetections) {
                        console.log('âœ… MermaidæŒç»­æ£€æµ‹å®Œæˆï¼Œæ‰€æœ‰å›¾è¡¨å·²æ¸²æŸ“');
                    } else {
                        console.log('â° MermaidæŒç»­æ£€æµ‹è¶…æ—¶ï¼Œåœæ­¢æ£€æµ‹');
                    }
                }
            }, detectionInterval);
        }

        // æŸ¥æ‰¾æœªæ¸²æŸ“çš„Mermaidä»£ç å—
        function findUnrenderedMermaidBlocks() {
            // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½åŒ…å«Mermaidä»£ç çš„preä»£ç å—
            const codeBlocks = document.querySelectorAll('pre code');
            const unrenderedBlocks = [];
            
            codeBlocks.forEach(block => {
                const codeContent = block.textContent.trim();
                // æ£€æŸ¥æ˜¯å¦ä¸ºMermaidä»£ç ä¸”æœªè¢«æ¸²æŸ“ï¼ˆæ²¡æœ‰è¢«è½¬æ¢ä¸ºmermaidç±»çš„divï¼‰
                if (codeContent && isMermaidCode(codeContent) && !block.closest('.mermaid')) {
                    unrenderedBlocks.push(block);
                }
            });
            
            return unrenderedBlocks;
        }

        function testPreRendering() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="markdown-content">
                    <h1>æµ‹è¯•æ ‡é¢˜</h1>
                    <p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ®µè½ï¼ŒåŒ…å«ä¸€äº›<strong>ç²—ä½“</strong>å’Œ<em>æ–œä½“</em>æ–‡æœ¬ã€‚</p>
                    
                    <pre>
# Markdownæ ‡é¢˜
è¿™æ˜¯ä¸€ä¸ªåœ¨preæ ‡ç­¾å†…çš„Markdownå†…å®¹ã€‚

## å­æ ‡é¢˜
- åˆ—è¡¨é¡¹1
- åˆ—è¡¨é¡¹2
- åˆ—è¡¨é¡¹3

**ç²—ä½“æ–‡æœ¬** å’Œ *æ–œä½“æ–‡æœ¬*

\`\`\`javascript
console.log('Hello World');
\`\`\`
                    </pre>
                    
                    <p>è¿™æ˜¯preæ ‡ç­¾åé¢çš„å†…å®¹ã€‚</p>
                </div>
            `;
            
            // æ¸²æŸ“preæ ‡ç­¾å†…çš„Markdownå†…å®¹
            renderPreTagMarkdown(content);
        }

        function testNestedContent() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="markdown-content">
                    <h1>åµŒå¥—å†…å®¹æµ‹è¯•</h1>
                    <p>æµ‹è¯•å¤šä¸ªpreæ ‡ç­¾çš„æƒ…å†µï¼š</p>
                    
                    <pre>
## ç¬¬ä¸€ä¸ªMarkdownå—
è¿™æ˜¯ä¸€ä¸ª**ç²—ä½“**æ–‡æœ¬ã€‚
                    </pre>
                    
                    <p>ä¸­é—´çš„æ™®é€šæ®µè½å†…å®¹ã€‚</p>
                    
                    <pre>
## ç¬¬äºŒä¸ªMarkdownå—
- é¡¹ç›®1
- é¡¹ç›®2
- é¡¹ç›®3

> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨å—
                    </pre>
                    
                    <p>æœ€åçš„æ™®é€šæ®µè½ã€‚</p>
                </div>
            `;
            
            // æ¸²æŸ“preæ ‡ç­¾å†…çš„Markdownå†…å®¹
            renderPreTagMarkdown(content);
        }

        function clearContent() {
            document.getElementById('content').innerHTML = '';
        }

        function testMermaidRendering() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="markdown-content">
                    <h1>Mermaidå›¾è¡¨æµ‹è¯•</h1>
                    <p>æµ‹è¯•preæ ‡ç­¾å†…çš„Mermaidä»£ç æ¸²æŸ“ï¼š</p>
                    
                    <pre>
graph TD
    A[å¼€å§‹] --> B{æ¡ä»¶åˆ¤æ–­}
    B -->|æ¡ä»¶1| C[æ‰§è¡Œæ­¥éª¤1]
    B -->|æ¡ä»¶2| D[æ‰§è¡Œæ­¥éª¤2]
    C --> E[ç»“æŸ]
    D --> E
                    </pre>
                    
                    <p>æµç¨‹å›¾åº”è¯¥è¢«æ¸²æŸ“ä¸ºå›¾è¡¨ã€‚</p>
                    
                    <pre>
sequenceDiagram
    participant ç”¨æˆ·
    participant ç³»ç»Ÿ
    ç”¨æˆ·->>ç³»ç»Ÿ: å‘é€è¯·æ±‚
    ç³»ç»Ÿ->>ç”¨æˆ·: è¿”å›å“åº”
                    </pre>
                    
                    <p>æ—¶åºå›¾ä¹Ÿåº”è¯¥è¢«æ­£ç¡®æ¸²æŸ“ã€‚</p>
                </div>
            `;
            
            // æ¸²æŸ“preæ ‡ç­¾å†…çš„å†…å®¹
            renderPreTagMarkdown(content);
            
            // å¯åŠ¨æŒç»­æ£€æµ‹æœºåˆ¶
            startMermaidDetection();
        }

        function testMixedContent() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="markdown-content">
                    <h1>æ··åˆå†…å®¹æµ‹è¯•</h1>
                    <p>æµ‹è¯•åŒæ—¶åŒ…å«æ™®é€šMarkdownå’ŒMermaidä»£ç ï¼š</p>
                    
                    <pre>
## æ™®é€šMarkdownå†…å®¹
è¿™æ˜¯ä¸€ä¸ª**ç²—ä½“**æ–‡æœ¬å’Œ*æ–œä½“*æ–‡æœ¬ã€‚

- åˆ—è¡¨é¡¹1
- åˆ—è¡¨é¡¹2
                    </pre>
                    
                    <p>ä¸­é—´çš„æ™®é€šå†…å®¹ã€‚</p>
                    
                    <pre>
graph LR
    A[èŠ‚ç‚¹A] --> B[èŠ‚ç‚¹B]
    B --> C[èŠ‚ç‚¹C]
                    </pre>
                    
                    <p>æœ€åæ˜¯å¦ä¸€ä¸ªæ™®é€šMarkdownï¼š</p>
                    
                    <pre>
### ä»£ç ç¤ºä¾‹
\`\`\`javascript
function hello() {
    console.log("Hello World!");
}
\`\`\`
                    </pre>
                </div>
            `;
            
            // æ¸²æŸ“preæ ‡ç­¾å†…çš„å†…å®¹
            renderPreTagMarkdown(content);
            
            // å¯åŠ¨æŒç»­æ£€æµ‹æœºåˆ¶
            startMermaidDetection();
        }
    </script>
</body>
</html>
