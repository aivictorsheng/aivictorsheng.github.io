<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Pre标签测试</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
        // 初始化Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    <style>
        .markdown-content {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }
        .markdown-content h1 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .markdown-content h2 {
            color: #444;
            margin-top: 20px;
        }
        .markdown-content p {
            margin-bottom: 15px;
            color: #555;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        .markdown-content li {
            margin-bottom: 8px;
        }
        .markdown-content code {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .markdown-content pre {
            background: #e8e8e8;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        .markdown-content blockquote {
            border-left: 4px solid #667eea;
            padding: 10px 20px;
            margin: 15px 0;
            background: #f0f0f0;
            color: #666;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div style="text-align: center; padding: 20px;">
        <h1> Markdown Pre标签渲染测试 </h1>
        <button onclick="testPreRendering()">测试Pre标签渲染</button>
        <button onclick="testNestedContent()">测试嵌套内容</button>
        <button onclick="testMermaidRendering()">测试Mermaid图表</button>
        <button onclick="testMixedContent()">测试混合内容</button>
        <button onclick="clearContent()">清空内容</button>
    </div>
    
    <div id="content" style="margin: 20px;"></div>

    <script>
        // 渲染markdown-content下的pre标签内容为Markdown输出
        function renderPreTagMarkdown(parentElement = document) {
            try {
                // 查找所有markdown-content元素下的pre标签
                const markdownContents = parentElement.querySelectorAll('.markdown-content');
                markdownContents.forEach(markdownContent => {
                    const preTags = markdownContent.querySelectorAll('pre');
                    preTags.forEach(preTag => {
                        try {
                            // 获取pre标签内的文本内容
                            const contentText = preTag.textContent || preTag.innerText;
                            if (contentText && contentText.trim()) {
                                const trimmedContent = contentText.trim();
                                
                                // 检查是否为Mermaid代码
                                if (isMermaidCode(trimmedContent)) {
                                    // 渲染为Mermaid图表
                                    renderMermaidFromPreTag(trimmedContent, preTag);
                                } else {
                                    // 使用marked解析Markdown内容
                                    if (typeof marked !== 'undefined' && marked.parse) {
                                        const renderedHtml = marked.parse(trimmedContent);
                                        // 创建新的div元素包含渲染后的内容
                                        const newDiv = document.createElement('div');
                                        newDiv.className = 'markdown-content';
                                        newDiv.innerHTML = renderedHtml;
                                        // 用新元素替换原来的pre标签
                                        preTag.parentNode.replaceChild(newDiv, preTag);
                                    } else {
                                        console.warn('⚠️ Marked.js未加载，无法渲染pre标签内容为Markdown');
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('⚠️ 渲染pre标签内容时出错:', error);
                        }
                    });
                });
            } catch (error) {
                console.warn('⚠️ 渲染pre标签Markdown时出错:', error);
            }
        }

        // 检查是否为Mermaid代码
        function isMermaidCode(code) {
            if (!code || code.length === 0) return false;
            
            // 检查是否有有效的起始行
            const firstLine = code.split('\n')[0].trim();
            const validStarts = ['graph', 'flowchart', 'sequenceDiagram', 'classDiagram', 
                               'stateDiagram', 'erDiagram', 'gantt', 'pie', 'journey',
                               'requirementDiagram', 'gitGraph'];
            
            return validStarts.some(start => firstLine.startsWith(start));
        }

        // 从pre标签渲染Mermaid图表
        function renderMermaidFromPreTag(mermaidCode, originalPreTag) {
            try {
                // 创建Mermaid图表容器
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                mermaidDiv.style.backgroundColor = '#ffffff';
                mermaidDiv.style.borderRadius = '8px';
                mermaidDiv.style.padding = '20px';
                mermaidDiv.style.margin = '20px 0';
                mermaidDiv.style.boxShadow = '0 2px 8px rgba(0, 0.1)';
                mermaidDiv.style.overflow = 'auto';
                mermaidDiv.setAttribute('data-mermaid-code', mermaidCode); // 保存原始代码用于重试
                
                // 用Mermaid图表替换原来的pre标签
                originalPreTag.parentNode.replaceChild(mermaidDiv, originalPreTag);
                
                // 渲染Mermaid图表
                renderMermaidWithRetry(mermaidDiv);
            } catch (error) {
                console.warn('⚠️ 渲染pre标签中的Mermaid图表时出错:', error);
            }
        }

        // 带重试机制的Mermaid渲染
        function renderMermaidWithRetry(mermaidElement, retryCount = 0) {
            const maxRetries = 5;
            const retryDelay = 500; // 500ms重试间隔
            
            // 检查Mermaid是否已加载并初始化
            if (typeof mermaid === 'undefined') {
                if (retryCount < maxRetries) {
                    console.log(`⏳ Mermaid未加载，${retryDelay}ms后重试 (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => renderMermaidWithRetry(mermaidElement, retryCount + 1), retryDelay);
                } else {
                    console.warn('⚠️ Mermaid库加载超时，无法渲染图表');
                    showMermaidFallback(mermaidElement);
                }
                return;
            }
            
            // 使用现代的Mermaid API渲染
            try {
                mermaid.run({
                    nodes: [mermaidElement],
                    postRenderCallback: (id) => {
                        console.log('✅ Pre标签中的Mermaid图表渲染完成:', id);
                    }
                }).catch((error) => {
                    if (retryCount < maxRetries) {
                        console.log(`⏳ Mermaid渲染失败，${retryDelay}ms后重试 (${retryCount + 1}/${maxRetries}):`, error.message);
                        setTimeout(() => renderMermaidWithRetry(mermaidElement, retryCount + 1), retryDelay);
                    } else {
                        console.warn('⚠️ Mermaid渲染重试次数已达上限:', error);
                        showMermaidFallback(mermaidElement);
                    }
                });
            } catch (e) {
                if (retryCount < maxRetries) {
                    console.log(`⏳ Mermaid渲染异常，${retryDelay}ms后重试 (${retryCount + 1}/${maxRetries}):`, e.message);
                    setTimeout(() => renderMermaidWithRetry(mermaidElement, retryCount + 1), retryDelay);
                } else {
                    console.warn('⚠️ Mermaid渲染异常重试次数已达上限:', e);
                    showMermaidFallback(mermaidElement);
                }
            }
        }

        // Mermaid渲染失败时的降级显示
        function showMermaidFallback(mermaidElement) {
            const code = mermaidElement.getAttribute('data-mermaid-code') || mermaidElement.textContent;
            mermaidElement.innerHTML = `
                <div style="text-align: left; font-family: monospace; font-size: 12px; color: #666;">
                    <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #ffc107;">
                        <strong>⚠️ Mermaid图表渲染失败</strong><br>
                        以下是原始Mermaid代码：
                    </div>
                    <pre style="background: #f1f3f4; padding: 15px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(code)}</pre>
                    <div style="margin-top: 10px; font-size: 11px; color: #888;">
                        提示：请检查网络连接或刷新页面重试
                    </div>
                </div>
            `;
        }

        // HTML转义辅助函数
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&',
                '<': '<',
                '>': '>',
                '"': '"',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // 启动Mermaid持续检测机制
        function startMermaidDetection() {
            let detectionCount = 0;
            const maxDetections = 50; // 最多检测50次（5秒）
            const detectionInterval = 100; // 100毫秒检测一次
            
            const detectionTimer = setInterval(() => {
                detectionCount++;
                
                // 检查页面中是否有未渲染的Mermaid代码块
                const unrenderedMermaidBlocks = findUnrenderedMermaidBlocks();
                
                if (unrenderedMermaidBlocks.length > 0) {
                    console.log(`🔍 检测到 ${unrenderedMermaidBlocks.length} 个未渲染的Mermaid代码块，正在进行渲染...`);
                    
                    // 渲染未渲染的Mermaid代码块
                    unrenderedMermaidBlocks.forEach(block => {
                        const codeContent = block.textContent.trim();
                        if (codeContent && isMermaidCode(codeContent)) {
                            // 创建Mermaid图表容器
                            const mermaidDiv = document.createElement('div');
                            mermaidDiv.className = 'mermaid';
                            mermaidDiv.textContent = codeContent;
                            mermaidDiv.style.backgroundColor = '#ffffff';
                            mermaidDiv.style.borderRadius = '8px';
                            mermaidDiv.style.padding = '20px';
                            mermaidDiv.style.margin = '20px 0';
                            mermaidDiv.style.boxShadow = '0 2px 8px rgba(0, 0.1)';
                            mermaidDiv.style.overflow = 'auto';
                            mermaidDiv.setAttribute('data-mermaid-code', codeContent);
                            
                            // 替换原来的代码块
                            block.parentNode.replaceChild(mermaidDiv, block);
                            
                            // 渲染Mermaid图表
                            renderMermaidWithRetry(mermaidDiv);
                        }
                    });
                }
                
                // 达到最大检测次数或没有未渲染的块时停止检测
                if (detectionCount >= maxDetections || unrenderedMermaidBlocks.length === 0) {
                    clearInterval(detectionTimer);
                    if (detectionCount < maxDetections) {
                        console.log('✅ Mermaid持续检测完成，所有图表已渲染');
                    } else {
                        console.log('⏰ Mermaid持续检测超时，停止检测');
                    }
                }
            }, detectionInterval);
        }

        // 查找未渲染的Mermaid代码块
        function findUnrenderedMermaidBlocks() {
            // 查找所有可能包含Mermaid代码的pre代码块
            const codeBlocks = document.querySelectorAll('pre code');
            const unrenderedBlocks = [];
            
            codeBlocks.forEach(block => {
                const codeContent = block.textContent.trim();
                // 检查是否为Mermaid代码且未被渲染（没有被转换为mermaid类的div）
                if (codeContent && isMermaidCode(codeContent) && !block.closest('.mermaid')) {
                    unrenderedBlocks.push(block);
                }
            });
            
            return unrenderedBlocks;
        }

        function testPreRendering() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="markdown-content">
                    <h1>测试标题</h1>
                    <p>这是一个测试段落，包含一些<strong>粗体</strong>和<em>斜体</em>文本。</p>
                    
                    <pre>
# Markdown标题
这是一个在pre标签内的Markdown内容。

## 子标题
- 列表项1
- 列表项2
- 列表项3

**粗体文本** 和 *斜体文本*

\`\`\`javascript
console.log('Hello World');
\`\`\`
                    </pre>
                    
                    <p>这是pre标签后面的内容。</p>
                </div>
            `;
            
            // 渲染pre标签内的Markdown内容
            renderPreTagMarkdown(content);
        }

        function testNestedContent() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="markdown-content">
                    <h1>嵌套内容测试</h1>
                    <p>测试多个pre标签的情况：</p>
                    
                    <pre>
## 第一个Markdown块
这是一个**粗体**文本。
                    </pre>
                    
                    <p>中间的普通段落内容。</p>
                    
                    <pre>
## 第二个Markdown块
- 项目1
- 项目2
- 项目3

> 这是一个引用块
                    </pre>
                    
                    <p>最后的普通段落。</p>
                </div>
            `;
            
            // 渲染pre标签内的Markdown内容
            renderPreTagMarkdown(content);
        }

        function clearContent() {
            document.getElementById('content').innerHTML = '';
        }

        function testMermaidRendering() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="markdown-content">
                    <h1>Mermaid图表测试</h1>
                    <p>测试pre标签内的Mermaid代码渲染：</p>
                    
                    <pre>
graph TD
    A[开始] --> B{条件判断}
    B -->|条件1| C[执行步骤1]
    B -->|条件2| D[执行步骤2]
    C --> E[结束]
    D --> E
                    </pre>
                    
                    <p>流程图应该被渲染为图表。</p>
                    
                    <pre>
sequenceDiagram
    participant 用户
    participant 系统
    用户->>系统: 发送请求
    系统->>用户: 返回响应
                    </pre>
                    
                    <p>时序图也应该被正确渲染。</p>
                </div>
            `;
            
            // 渲染pre标签内的内容
            renderPreTagMarkdown(content);
            
            // 启动持续检测机制
            startMermaidDetection();
        }

        function testMixedContent() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="markdown-content">
                    <h1>混合内容测试</h1>
                    <p>测试同时包含普通Markdown和Mermaid代码：</p>
                    
                    <pre>
## 普通Markdown内容
这是一个**粗体**文本和*斜体*文本。

- 列表项1
- 列表项2
                    </pre>
                    
                    <p>中间的普通内容。</p>
                    
                    <pre>
graph LR
    A[节点A] --> B[节点B]
    B --> C[节点C]
                    </pre>
                    
                    <p>最后是另一个普通Markdown：</p>
                    
                    <pre>
### 代码示例
\`\`\`javascript
function hello() {
    console.log("Hello World!");
}
\`\`\`
                    </pre>
                </div>
            `;
            
            // 渲染pre标签内的内容
            renderPreTagMarkdown(content);
            
            // 启动持续检测机制
            startMermaidDetection();
        }
    </script>
</body>
</html>
